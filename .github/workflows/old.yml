name: KotIT Pipeline Runner - Modular Jobs

on:
  workflow_dispatch:
  push:
    branches:
      - test

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Android repo
        uses: actions/checkout@v4

      - name: Clone kotIT repo
        run: git clone https://github.com/Siddhant53000/kotIT.git kotIT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          cd kotIT
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run KotIT pipeline
        run: |
          cd kotIT
          python3 kotit_pipeline_new.py all \
            --android_repo $GITHUB_WORKSPACE \
            --app_name YourApp \
            --package com.your.app \
            --modules '["core"]' \
            --ios_repo /absolute/path/to/ios/repo \
            --xcodeproj Archi2.xcodeproj Debug

      - name: Upload SwiftOut artifact
        uses: actions/upload-artifact@v4
        with:
          name: SwiftOut
          path: kotIT/SwiftOut

  push:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download SwiftOut artifact
        uses: actions/download-artifact@v4
        with:
          name: SwiftOut
          path: SwiftOut

      - name: Push SwiftOut to Output Repo
        run: |
          cd SwiftOut
          git init
          git config user.name "${{ secrets.GIT_USER_NAME }}"
          git config user.email "${{ secrets.GIT_USER_EMAIL }}"
          git remote add origin https://x-access-token:${{ secrets.USER_GITHUB_TOKEN }}@github.com/YourOrg/your-output-repo.git
          git add .
          git commit -m "Automated SwiftOut update from pipeline"
          git branch -M main
          git push -f origin main
